import { withAssetPrefix } from "gatsby";
import { usePrismicPreviewStore } from "../usePrismicPreviewStore.js";
import { fetchLinkedDocuments } from "./fetchLinkedDocuments.js";
import { fetchNewDocuments } from "./fetchNewDocuments.js";
import { fetchPublishedDocumentIDs } from "./fetchPublishedDocumentIDs.js";
import { fmtLog } from "./fmtLog.js";
import { getClient } from "./getClient.js";
import { getPluginOptions } from "./getPluginOptions.js";
import { getRepositoryConfig } from "./getRepositoryConfig.js";
import { normalizeDocument } from "./normalizeDocument.js";
const bootstrapPrismicPreview = async (repositoryName, abortController) => {
  const state = usePrismicPreviewStore.getState();
  if (state.isBootstrapped) {
    return;
  }
  const pluginOptions = getPluginOptions(repositoryName);
  if (!pluginOptions) {
    console.error(fmtLog(repositoryName, `Plugin options could not be found. Did you add "gatsby-plugin-prismic-previews" for this repository to your app's "gatsby-config.js" file?`));
    return;
  }
  const repositoryConfig = getRepositoryConfig(repositoryName);
  if (!repositoryConfig) {
    console.error(fmtLog(repositoryName, 'Repository configuration could not be found. Did you add <PrismicPreviewProvider> to your "gatsby-browser.js" and "gatsby-ssr.js"? It must contain a repository configuration object for this repository.'));
    return;
  }
  const client = getClient(pluginOptions);
  const signal = abortController.signal;
  await client.getCachedRepository();
  const [localPublishedDocumentIDs, newDocuments] = await Promise.all([
    fetchPublishedDocumentIDs({
      client,
      abortController,
      pluginOptions
    }),
    fetchNewDocuments({ client, abortController })
  ]);
  if (localPublishedDocumentIDs.length) {
    state.setPublishedDocumentIDs(localPublishedDocumentIDs);
  }
  const modelsRaw = await fetch(withAssetPrefix(__PUBLIC_MODELS_PATH__), {
    signal
  });
  const models = await modelsRaw.json();
  const modelsForRepository = models[pluginOptions.repositoryName];
  await Promise.all([
    fetchLinkedDocuments(newDocuments, client, pluginOptions, repositoryConfig, modelsForRepository.customTypeModels, modelsForRepository.sharedSliceModels, abortController),
    Promise.all(newDocuments.map(async (doc) => {
      const model = modelsForRepository.customTypeModels.find((model2) => model2.id === doc.type);
      if (model) {
        const normalizedDocument = await normalizeDocument(doc, model, modelsForRepository.sharedSliceModels, repositoryConfig, pluginOptions);
        state.addDocument(normalizedDocument);
      }
    }))
  ]);
  state.setIsBootstrapped(true);
};
export {
  bootstrapPrismicPreview as default
};
//# sourceMappingURL=bootstrapPrismicPreview.js.map
